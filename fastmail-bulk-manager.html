<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fastmail Bulk Manager</title>
    <!--
    ========================================================================
    EDUCATIONAL CODEBASE NOTICE
    ========================================================================
    
    This project includes extensive educational comments throughout the code
    to help people learn web development, JavaScript, and email APIs.
    
    These comments explain:
    â€¢ What each section of code does
    â€¢ Why certain approaches were chosen
    â€¢ How underlying technologies work
    â€¢ Best practices and common patterns
    
    CONTRIBUTORS: You can help maintain this educational value by:
    âœ… Preserving existing educational comments when making changes
    âœ… Updating comments when functionality changes to keep them accurate
    ðŸ’¡ Optionally adding explanatory comments for new code (welcomed but not required!)
    ðŸ’¡ Improving existing explanations if you spot unclear or outdated info
    
    All contributions are welcome regardless of commenting style - clear code
    and good pull request descriptions help the community understand changes.
    
    Thank you for helping maintain this project's educational mission!
    ========================================================================
    -->
    <style>
        /* 
         * CSS STYLING SECTION
         * This section defines the visual appearance of our web application
         * CSS (Cascading Style Sheets) controls colors, fonts, layouts, and animations
         */
        
        /* Body styles - affects the entire page */
        body {
            /* Font stack - tries each font until it finds one available on the user's system */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;        /* Prevents content from getting too wide on large screens */
            margin: 0 auto;           /* Centers the content horizontally */
            padding: 20px;            /* Adds space around the edges */
            background: #f5f5f5;      /* Light gray background color */
        }
        
        /* Card-style containers for different sections */
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;       /* Rounded corners */
            margin-bottom: 20px;
            /* Box shadow creates a subtle 3D effect: horizontal, vertical, blur, color */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .config-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Individual sender cards */
        .sender-card {
            background: white;
            border: 1px solid #e0e0e0; /* Light gray border */
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Flexbox layout for sender information */
        .sender-header {
            display: flex;              /* Enables flexible box layout */
            justify-content: between;   /* Distributes space between items */
            align-items: center;        /* Vertically centers items */
            margin-bottom: 15px;
        }
        
        /* Typography styles for sender information */
        .sender-email {
            font-weight: 600;          /* Semi-bold text */
            font-size: 16px;
            color: #333;               /* Dark gray text */
        }
        
        .message-count {
            color: #666;               /* Medium gray for secondary text */
            font-size: 14px;
        }
        
        .message-preview {
            margin: 10px 0;
            font-size: 14px;
            color: #666;
        }
        
        .actions {
            margin-top: 15px;
        }
        
        /* Button styling with different variants */
        .action-button {
            background: #007bff;       /* Bootstrap-style blue */
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;           /* Shows hand cursor on hover */
            margin-right: 10px;
            margin-bottom: 5px;
        }
        
        /* Hover effect - changes color when mouse is over button */
        .action-button:hover {
            background: #0056b3;       /* Darker blue */
        }
        
        /* Button variants using CSS classes */
        .action-button.secondary {
            background: #6c757d;       /* Gray background */
        }
        
        .action-button.secondary:hover {
            background: #545b62;       /* Darker gray on hover */
        }
        
        .action-button.danger {
            background: #dc3545;       /* Red for dangerous actions */
        }
        
        .action-button.danger:hover {
            background: #c82333;       /* Darker red on hover */
        }
        
        /* Form styling */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;            /* Makes labels take full width */
            margin-bottom: 5px;
            font-weight: 500;          /* Medium weight text */
        }
        
        /* Input field styling */
        input, select {
            width: 100%;              /* Full width of container */
            padding: 8px;
            border: 1px solid #ddd;   /* Light border */
            border-radius: 4px;
        }
        
        /* Status message styling with color coding */
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        /* Different status types using CSS classes */
        .status.success {
            background: #d4edda;      /* Light green background */
            color: #155724;           /* Dark green text */
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;      /* Light red background */
            color: #721c24;           /* Dark red text */
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;      /* Light blue background */
            color: #0c5460;           /* Dark blue text */
            border: 1px solid #b8daff;
        }
        
        /* Utility classes */
        .hidden {
            display: none;            /* Completely hides elements */
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        /* 
         * MODAL DIALOG STYLING
         * Modals are popup windows that appear over the main content
         */
        .modal {
            display: none;            /* Hidden by default */
            position: fixed;          /* Stays in same place when scrolling */
            z-index: 1000;           /* High z-index ensures it appears above everything */
            left: 0;
            top: 0;
            width: 100%;             /* Full screen overlay */
            height: 100%;
            background-color: rgba(0,0,0,0.5); /* Semi-transparent black background */
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;         /* Centers the modal vertically and horizontally */
            padding: 20px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;          /* Responsive: shrinks on small screens */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .confirmation-details {
            background: #f8f9fa;      /* Very light gray background */
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        
        .modal-actions {
            text-align: right;        /* Right-aligns the action buttons */
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Fastmail Bulk Manager</h1>
        <p>Review and manage messages you've moved to bulk folders</p>
        
        <details style="margin-top: 15px;">
            <summary style="cursor: pointer; font-weight: 500;">ðŸ“‹ Feature Roadmap</summary>
            <div style="margin-top: 10px; padding-left: 20px; font-size: 14px; color: #666;">
                <h4>Future Features Under Consideration:</h4>
                <ul>
                    <li><strong>Sample Message Viewer:</strong> Preview one or more sample emails from a sender before taking action</li>
                    <li><strong>Smart Rule Cleanup:</strong> Detect unsubscribe actions and offer to remove related auto-rules to keep things tidy</li>
                    <li><strong>Reverse Actions:</strong> Detect when messages are removed from Bulk and ask about moving all messages from that sender and/or modifying rules</li>
                    <li><strong>Open Source:</strong> Add this project to GitHub for community contributions and improvements</li>
                    <li><strong>Browser Extension API:</strong> Simple API to enable hybrid browser extension integration</li>
                    <li><strong>Fastmail Tool Suite:</strong> Create other complementary Fastmail tools with similar design that can work together</li>
                    <li><strong>Message Search:</strong> Find specific messages across senders and time periods</li>
                    <li><strong>Rule Management:</strong> View, edit, and delete existing filter rules</li>
                    <li><strong>Statistics Dashboard:</strong> Show trends of bulk message patterns over time</li>
                </ul>
            </div>
        </details>
    </div>

    <div class="config-section">
        <h2>Configuration</h2>
        <form id="configForm">
            <div class="form-group">
                <label for="server">JMAP Server:</label>
                <input type="text" id="server" value="https://jmap.fastmail.com/.well-known/jmap" readonly>
            </div>
            <div class="form-group">
                <label for="username">Username (email):</label>
                <input type="email" id="username" required>
            </div>
            <div class="form-group">
                <label for="password">App Password:</label>
                <input type="password" id="password" required>
                <small>Generate an app password in Fastmail Settings â†’ Privacy & Security â†’ App Passwords</small>
            </div>
            <div class="form-group">
                <label for="bulkFolder">Bulk Folder Name:</label>
                <input type="text" id="bulkFolder" value="Bulk" placeholder="Enter folder name (e.g., Bulk, Spam, Junk)">
            </div>
            <div class="form-group">
                <label for="daysPast">Review messages from past:</label>
                <select id="daysPast">
                    <option value="1">1 day</option>
                    <option value="3">3 days</option>
                    <option value="7" selected>7 days</option>
                    <option value="14">14 days</option>
                    <option value="30">30 days</option>
                </select>
            </div>
            <button type="submit" class="action-button">Connect & Scan</button>
        </form>
        <div id="connectionStatus"></div>
    </div>

    <div id="results" class="hidden">
        <h2>Messages Moved to Bulk</h2>
        <div class="form-group">
            <button class="action-button secondary" onclick="selectAllSenders()">Select All</button>
            <button class="action-button secondary" onclick="deselectAllSenders()">Deselect All</button>
            <button class="action-button" onclick="bulkAction('move')" id="bulkMoveBtn" disabled>Move Selected</button>
            <button class="action-button secondary" onclick="bulkAction('rule')" id="bulkRuleBtn" disabled>Create Rules for Selected</button>
        </div>
        <div id="sendersContainer">
            <div class="loading">Scanning your messages...</div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Confirm Action</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
            <div class="modal-actions">
                <button class="action-button secondary" onclick="closeModal()">Cancel</button>
                <button class="action-button" id="confirmBtn" onclick="confirmAction()">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        /*
         * JAVASCRIPT SECTION
         * This contains the application logic for connecting to Fastmail and managing emails
         * JavaScript is a programming language that runs in web browsers
         */
        
        /*
         * EXTENSIBILITY FOUNDATION
         * This creates a global object that can be shared between multiple tools
         * The || operator provides a default value if FastmailToolkit doesn't exist yet
         */
        window.FastmailToolkit = window.FastmailToolkit || {
            version: '0.1.0',
            tools: {},                // Object to store multiple tool instances
            sharedAuth: null,         // Shared authentication data
            
            // Method to register new tools in the toolkit
            registerTool: function(name, tool) {
                this.tools[name] = tool;
            },
            
            // Method to get shared authentication data
            getSharedAuth: function() {
                return this.sharedAuth;
            },
            
            // Method to store authentication data for other tools to use
            setSharedAuth: function(auth) {
                this.sharedAuth = auth;
            }
        };

        /*
         * MAIN APPLICATION CLASS
         * ES6 class syntax for creating objects with methods and properties
         * Classes are blueprints for creating objects
         */
        class FastmailBulkManager {
            /*
             * CONSTRUCTOR
             * Special method that runs when creating a new instance of the class
             * Initializes the object's properties with default values
             */
            constructor() {
                this.session = null;      // Will store JMAP session data
                this.accountId = null;    // User's account identifier
                this.bulkFolderId = null; // ID of the bulk/spam folder
                this.baseUrl = null;      // Base URL for JMAP API calls
            }

            /*
             * AUTHENTICATION METHOD
             * Async/await syntax for handling asynchronous operations
             * This connects to Fastmail's JMAP API using app passwords
             */
            async connect(server, username, password) {
                try {
                    /*
                     * FETCH API
                     * Modern way to make HTTP requests in JavaScript
                     * fetch() returns a Promise that resolves to the Response object
                     */
                    const sessionResponse = await fetch(server, {
                        method: 'GET',
                        headers: {
                            /*
                             * HTTP BASIC AUTHENTICATION
                             * btoa() encodes username:password in Base64
                             * This is how we authenticate with Fastmail's API
                             */
                            'Authorization': `Basic ${btoa(username + ':' + password)}`
                        }
                    });

                    // Check if the HTTP request was successful
                    if (!sessionResponse.ok) {
                        throw new Error(`Authentication failed: ${sessionResponse.status}`);
                    }

                    /*
                     * JSON PARSING
                     * Convert the response from JSON string to JavaScript object
                     * await waits for the Promise to resolve
                     */
                    this.session = await sessionResponse.json();
                    this.baseUrl = this.session.apiUrl;
                    
                    /*
                     * OBJECT PROPERTY ACCESS
                     * Accessing nested properties using bracket notation
                     * This gets the mail account ID from the session data
                     */
                    this.accountId = this.session.primaryAccounts['urn:ietf:params:jmap:mail'];

                    /*
                     * SHARED AUTHENTICATION STORAGE
                     * Store authentication data so other tools can reuse it
                     * This supports the extensibility roadmap
                     */
                    window.FastmailToolkit.setSharedAuth({
                        server, username, password,
                        session: this.session,
                        baseUrl: this.baseUrl,
                        accountId: this.accountId
                    });

                    // Return success object
                    return { success: true };
                } catch (error) {
                    /*
                     * ERROR HANDLING
                     * Catch any errors and return them in a consistent format
                     * This prevents the application from crashing
                     */
                    return { success: false, error: error.message };
                }
            }

            async findBulkFolder(folderName) {
                try {
                    const response = await this.makeJMAPCall([
                        ['Mailbox/get', {
                            accountId: this.accountId,
                            properties: ['id', 'name', 'parentId', 'role']
                        }, '0']
                    ]);

                    const mailboxes = response[0][1].list;
                    
                    // First try to find by role
                    let bulkFolder = mailboxes.find(mb => mb.role === 'junk');
                    
                    // If not found, try by name (case insensitive)
                    if (!bulkFolder) {
                        bulkFolder = mailboxes.find(mb => 
                            mb.name.toLowerCase() === folderName.toLowerCase()
                        );
                    }

                    if (bulkFolder) {
                        this.bulkFolderId = bulkFolder.id;
                        return { success: true, folder: bulkFolder };
                    } else {
                        return { success: false, error: `Folder "${folderName}" not found` };
                    }
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            async scanBulkMessages(daysPast) {
                try {
                    const sinceDate = new Date();
                    sinceDate.setDate(sinceDate.getDate() - daysPast);
                    
                    const response = await this.makeJMAPCall([
                        ['Email/query', {
                            accountId: this.accountId,
                            filter: {
                                inMailbox: this.bulkFolderId,
                                after: sinceDate.toISOString()
                            }
                        }, '0'],
                        ['Email/get', {
                            accountId: this.accountId,
                            '#ids': {
                                resultOf: '0',
                                name: 'Email/query',
                                path: '/ids'
                            },
                            properties: ['id', 'subject', 'from', 'receivedAt', 'mailboxIds']
                        }, '1']
                    ]);

                    const emails = response[1][1].list;
                    return this.groupBySender(emails);
                } catch (error) {
                    throw error;
                }
            }

            groupBySender(emails) {
                const senderGroups = {};
                
                emails.forEach(email => {
                    const fromEmail = email.from[0].email;
                    const fromName = email.from[0].name || fromEmail;
                    
                    if (!senderGroups[fromEmail]) {
                        senderGroups[fromEmail] = {
                            email: fromEmail,
                            name: fromName,
                            messages: [],
                            count: 0
                        };
                    }
                    
                    senderGroups[fromEmail].messages.push({
                        id: email.id,
                        subject: email.subject,
                        receivedAt: email.receivedAt
                    });
                    senderGroups[fromEmail].count++;
                });

                return Object.values(senderGroups).sort((a, b) => b.count - a.count);
            }

            async makeJMAPCall(requests) {
                const response = await fetch(this.baseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': document.getElementById('password').value ? 
                            `Basic ${btoa(document.getElementById('username').value + ':' + document.getElementById('password').value)}` : ''
                    },
                    body: JSON.stringify({
                        using: ['urn:ietf:params:jmap:core', 'urn:ietf:params:jmap:mail'],
                        methodCalls: requests
                    })
                });

                if (!response.ok) {
                    throw new Error(`JMAP call failed: ${response.status}`);
                }

                const data = await response.json();
                return data.methodResponses;
            }

            async moveMessagesFromSender(senderEmail) {
                try {
                    // First, find all messages from this sender NOT in bulk folder
                    const response = await this.makeJMAPCall([
                        ['Email/query', {
                            accountId: this.accountId,
                            filter: {
                                from: senderEmail,
                                notInMailbox: this.bulkFolderId
                            }
                        }, '0'],
                        ['Email/get', {
                            accountId: this.accountId,
                            '#ids': {
                                resultOf: '0',
                                name: 'Email/query',
                                path: '/ids'
                            },
                            properties: ['id', 'mailboxIds']
                        }, '1']
                    ]);

                    const emails = response[1][1].list;
                    
                    if (emails.length === 0) {
                        return { success: true, moved: 0, message: 'No messages to move' };
                    }

                    // Prepare updates to move messages to bulk folder
                    const updates = {};
                    emails.forEach(email => {
                        const newMailboxIds = { ...email.mailboxIds };
                        
                        // Remove from all current mailboxes and add to bulk
                        Object.keys(newMailboxIds).forEach(id => delete newMailboxIds[id]);
                        newMailboxIds[this.bulkFolderId] = true;
                        
                        updates[email.id] = {
                            mailboxIds: newMailboxIds
                        };
                    });

                    // Execute the move
                    const moveResponse = await this.makeJMAPCall([
                        ['Email/set', {
                            accountId: this.accountId,
                            update: updates
                        }, '0']
                    ]);

                    const result = moveResponse[0][1];
                    const movedCount = Object.keys(result.updated || {}).length;
                    const errors = result.notUpdated || {};

                    if (Object.keys(errors).length > 0) {
                        console.warn('Some messages could not be moved:', errors);
                    }

                    return { 
                        success: true, 
                        moved: movedCount,
                        errors: Object.keys(errors).length,
                        message: `Moved ${movedCount} messages${Object.keys(errors).length > 0 ? ` (${Object.keys(errors).length} failed)` : ''}`
                    };
                    
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            async createRule(senderEmail) {
                try {
                    // Get current Sieve script
                    const getResponse = await this.makeJMAPCall([
                        ['SieveScript/get', {
                            accountId: this.accountId
                        }, '0']
                    ]);

                    let activeScript = getResponse[0][1].list.find(script => script.isActive);
                    let scriptContent = activeScript ? activeScript.blobId : '';
                    
                    // If we have an existing script, get its content
                    if (scriptContent) {
                        // In a real implementation, you'd fetch the blob content here
                        // For now, we'll append to existing rules
                        scriptContent = '# Existing rules would be here\n\n';
                    } else {
                        scriptContent = '# Auto-generated rules by Fastmail Bulk Manager\n\n';
                    }

                    // Generate new rule
                    const newRule = `# Rule for ${senderEmail}
if address :is "from" "${senderEmail}" {
    fileinto "Bulk";
    stop;
}

`;

                    const updatedScript = scriptContent + newRule;

                    // Create or update the script
                    const scriptName = activeScript ? activeScript.name : 'bulk-manager-rules';
                    const scriptId = activeScript ? activeScript.id : null;

                    const setCall = scriptId ? 
                        ['SieveScript/set', {
                            accountId: this.accountId,
                            update: {
                                [scriptId]: {
                                    source: updatedScript
                                }
                            }
                        }, '0'] :
                        ['SieveScript/set', {
                            accountId: this.accountId,
                            create: {
                                'new-rule': {
                                    name: scriptName,
                                    source: updatedScript,
                                    isActive: true
                                }
                            }
                        }, '0'];

                    const setResponse = await this.makeJMAPCall([setCall]);
                    
                    const result = setResponse[0][1];
                    
                    if (result.created || result.updated) {
                        return { 
                            success: true, 
                            message: `Created rule to move messages from ${senderEmail} to bulk folder`
                        };
                    } else {
                        throw new Error('Failed to create rule: ' + JSON.stringify(result.notCreated || result.notUpdated));
                    }
                    
                } catch (error) {
                    // Fallback: Try a simpler approach or provide helpful error
                    if (error.message.includes('SieveScript')) {
                        return { 
                            success: false, 
                            error: 'Sieve script management not available. You can manually create a rule in Fastmail Settings â†’ Rules.' 
                        };
                    }
                    return { success: false, error: error.message };
                }
            }
        }

        // Initialize the manager and register with toolkit
        const manager = new FastmailBulkManager();
        window.FastmailToolkit.registerTool('bulkManager', manager);
        
        // Handle form submission
        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const server = document.getElementById('server').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const bulkFolder = document.getElementById('bulkFolder').value;
            const daysPast = parseInt(document.getElementById('daysPast').value);
            
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.innerHTML = '<div class="status info">Connecting...</div>';
            
            try {
                // Connect to JMAP
                const connectResult = await manager.connect(server, username, password);
                if (!connectResult.success) {
                    throw new Error(connectResult.error);
                }
                
                // Find bulk folder
                const folderResult = await manager.findBulkFolder(bulkFolder);
                if (!folderResult.success) {
                    throw new Error(folderResult.error);
                }
                
                statusDiv.innerHTML = '<div class="status success">Connected successfully!</div>';
                
                // Show results section and scan messages
                document.getElementById('results').classList.remove('hidden');
                await scanMessages(daysPast);
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">Error: ${error.message}</div>`;
            }
        });

        async function scanMessages(daysPast) {
            try {
                const senders = await manager.scanBulkMessages(daysPast);
                displaySenders(senders);
            } catch (error) {
                document.getElementById('sendersContainer').innerHTML = 
                    `<div class="status error">Error scanning messages: ${error.message}</div>`;
            }
        }

        function displaySenders(senders) {
            const container = document.getElementById('sendersContainer');
            
            if (senders.length === 0) {
                container.innerHTML = '<div class="status info">No messages found in bulk folder for the selected time period.</div>';
                return;
            }
            
            const html = senders.map(sender => `
                <div class="sender-card">
                    <div class="sender-header">
                        <div style="flex: 1;">
                            <input type="checkbox" id="sender_${sender.email}" class="sender-checkbox" onchange="updateBulkButtons()">
                            <label for="sender_${sender.email}" style="display: inline; margin-left: 10px;">
                                <span class="sender-email">${sender.name} (${sender.email})</span>
                            </label>
                            <div class="message-count">${sender.count} messages in bulk folder</div>
                        </div>
                    </div>
                    
                    <div class="message-preview">
                        Recent subjects: ${sender.messages.slice(0, 3).map(m => m.subject).join(' â€¢ ')}
                        ${sender.count > 3 ? ' â€¢ ...' : ''}
                    </div>
                    
                    <div class="actions">
                        <button class="action-button" onclick="showMoveConfirmation('${sender.email}', '${sender.name}')">
                            Move All From This Sender
                        </button>
                        <button class="action-button secondary" onclick="showRuleConfirmation('${sender.email}', '${sender.name}')">
                            Create Auto-Rule
                        </button>
                        <button class="action-button secondary" onclick="viewMessages('${sender.email}')">
                            View Messages
                        </button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // Modal and confirmation handling
        let pendingAction = null;

        function showMoveConfirmation(senderEmail, senderName) {
            document.getElementById('modalTitle').textContent = 'Confirm Move Messages';
            document.getElementById('modalBody').innerHTML = `
                <p>Are you sure you want to move <strong>all messages</strong> from <strong>${senderName}</strong> to the bulk folder?</p>
                <div class="confirmation-details">
                    <strong>Sender:</strong> ${senderEmail}<br>
                    <strong>Action:</strong> Move all non-bulk messages from this sender to bulk folder
                </div>
                <p><em>This action cannot be easily undone.</em></p>
            `;
            
            pendingAction = { type: 'move', email: senderEmail, name: senderName };
            document.getElementById('confirmationModal').style.display = 'block';
        }

        function showRuleConfirmation(senderEmail, senderName) {
            document.getElementById('modalTitle').textContent = 'Confirm Create Rule';
            document.getElementById('modalBody').innerHTML = `
                <p>Create an automatic rule to move future messages from <strong>${senderName}</strong> to bulk?</p>
                <div class="confirmation-details">
                    <strong>Sender:</strong> ${senderEmail}<br>
                    <strong>Action:</strong> Create filter rule to automatically move future messages to bulk folder
                </div>
                <p><em>You can manage rules later in Fastmail's Settings.</em></p>
            `;
            
            pendingAction = { type: 'rule', email: senderEmail, name: senderName };
            document.getElementById('confirmationModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('confirmationModal').style.display = 'none';
            pendingAction = null;
        }

        async function confirmAction() {
            if (!pendingAction) return;
            
            const confirmBtn = document.getElementById('confirmBtn');
            const originalText = confirmBtn.textContent;
            confirmBtn.textContent = 'Processing...';
            confirmBtn.disabled = true;
            
            try {
                if (pendingAction.type === 'move') {
                    await executeMove(pendingAction.email);
                } else if (pendingAction.type === 'rule') {
                    await executeRule(pendingAction.email);
                } else if (pendingAction.type === 'bulk_move') {
                    await executeBulkMove(pendingAction.senders);
                } else if (pendingAction.type === 'bulk_rule') {
                    await executeBulkRule(pendingAction.senders);
                }
            } finally {
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;
                closeModal();
            }
        }

        async function executeMove(senderEmail) {
            try {
                const result = await manager.moveMessagesFromSender(senderEmail);
                if (result.success) {
                    const message = result.message || `Moved ${result.moved} messages from ${senderEmail} to bulk folder`;
                    showStatus(message, result.errors > 0 ? 'warning' : 'success');
                    
                    // Refresh the display
                    const daysPast = parseInt(document.getElementById('daysPast').value);
                    await scanMessages(daysPast);
                } else {
                    showStatus(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function executeRule(senderEmail) {
            try {
                const result = await manager.createRule(senderEmail);
                if (result.success) {
                    const message = result.message || `Created rule to automatically move messages from ${senderEmail} to bulk`;
                    showStatus(message, 'success');
                } else {
                    showStatus(`Error: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        async function executeBulkMove(senderEmails) {
            const results = [];
            let totalMoved = 0;
            let totalErrors = 0;

            for (const senderEmail of senderEmails) {
                try {
                    const result = await manager.moveMessagesFromSender(senderEmail);
                    results.push({ sender: senderEmail, result });
                    if (result.success) {
                        totalMoved += result.moved || 0;
                        totalErrors += result.errors || 0;
                    }
                } catch (error) {
                    results.push({ sender: senderEmail, result: { success: false, error: error.message } });
                    totalErrors++;
                }
            }

            const successCount = results.filter(r => r.result.success).length;
            showStatus(`Bulk move completed: ${successCount}/${senderEmails.length} senders processed, ${totalMoved} messages moved${totalErrors > 0 ? ` (${totalErrors} errors)` : ''}`, 
                      successCount === senderEmails.length ? 'success' : 'warning');

            // Refresh the display
            const daysPast = parseInt(document.getElementById('daysPast').value);
            await scanMessages(daysPast);
        }

        async function executeBulkRule(senderEmails) {
            const results = [];

            for (const senderEmail of senderEmails) {
                try {
                    const result = await manager.createRule(senderEmail);
                    results.push({ sender: senderEmail, result });
                } catch (error) {
                    results.push({ sender: senderEmail, result: { success: false, error: error.message } });
                }
            }

            const successCount = results.filter(r => r.result.success).length;
            showStatus(`Bulk rule creation completed: ${successCount}/${senderEmails.length} rules created`, 
                      successCount === senderEmails.length ? 'success' : 'warning');
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            
            const container = document.getElementById('results');
            container.insertBefore(statusDiv, container.firstChild);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.parentNode.removeChild(statusDiv);
                }
            }, 5000);
        }

        // Bulk action handlers
        function selectAllSenders() {
            document.querySelectorAll('.sender-checkbox').forEach(cb => cb.checked = true);
            updateBulkButtons();
        }

        function deselectAllSenders() {
            document.querySelectorAll('.sender-checkbox').forEach(cb => cb.checked = false);
            updateBulkButtons();
        }

        function updateBulkButtons() {
            const checkedCount = document.querySelectorAll('.sender-checkbox:checked').length;
            const moveBtn = document.getElementById('bulkMoveBtn');
            const ruleBtn = document.getElementById('bulkRuleBtn');
            
            moveBtn.disabled = checkedCount === 0;
            ruleBtn.disabled = checkedCount === 0;
            
            moveBtn.textContent = `Move Selected (${checkedCount})`;
            ruleBtn.textContent = `Create Rules for Selected (${checkedCount})`;
        }

        function bulkAction(actionType) {
            const checkedSenders = Array.from(document.querySelectorAll('.sender-checkbox:checked'))
                .map(cb => cb.id.replace('sender_', ''));
            
            if (checkedSenders.length === 0) return;
            
            const actionText = actionType === 'move' ? 'move all messages from' : 'create rules for';
            const title = actionType === 'move' ? 'Confirm Bulk Move' : 'Confirm Bulk Rule Creation';
            
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = `
                <p>Are you sure you want to ${actionText} <strong>${checkedSenders.length}</strong> selected senders?</p>
                <div class="confirmation-details">
                    <strong>Selected senders:</strong><br>
                    ${checkedSenders.slice(0, 5).join('<br>')}
                    ${checkedSenders.length > 5 ? `<br>...and ${checkedSenders.length - 5} more` : ''}
                </div>
            `;
            
            pendingAction = { type: `bulk_${actionType}`, senders: checkedSenders };
            document.getElementById('confirmationModal').style.display = 'block';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('confirmationModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        async function moveAllFromSender(senderEmail) {
            try {
                const result = await manager.moveMessagesFromSender(senderEmail);
                if (result.success) {
                    alert(`Moved ${result.moved} messages from ${senderEmail} to bulk folder`);
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function createRuleForSender(senderEmail) {
            try {
                const result = await manager.createRule(senderEmail);
                if (result.success) {
                    alert(`Created rule to automatically move messages from ${senderEmail} to bulk`);
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        function viewMessages(senderEmail) {
            alert(`Would show detailed message list for ${senderEmail}`);
        }
    </script>
</body>
</html>
